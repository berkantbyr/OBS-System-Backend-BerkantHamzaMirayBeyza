
> university-obs-backend@1.0.0 test
> jest --coverage --detectOpenHandles --testPathPattern=authService.test.js --testNamePattern=register

node.exe : FAIL tests
/unit/authService.tes
t.js
At line:1 char:1
+ & "C:\Program Files
\nodejs/node.exe" 
"C:\Program 
Files\nodejs/node_mo 
...
+ ~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~
    + CategoryInfo   
           : NotSpe  
  cified: (FAIL te   
 sts/unit/authSer    
vice.test.js:Str    
ing) [], RemoteE    
xception
    + FullyQualified 
   ErrorId : Native  
  CommandError
 
  Auth Service - 
Unit Tests
    register
      ├ù should 
successfully 
register a new 
student (5 ms)
      ├ù should 
successfully 
register a new 
faculty member (1 ms)
      ÔêÜ should 
throw error if email 
already exists (2 ms)
      ├ù should 
throw error if 
student number 
already exists (11 
ms)
      ├ù should 
throw error if 
employee number 
already exists (5 ms)
      ÔêÜ should 
throw error if 
department does not 
exist (1 ms)
      ÔêÜ should 
rollback transaction 
on error (1 ms)
    verifyEmail
      Ôùï skipped 
should successfully 
verify email with 
valid token
      Ôùï skipped 
should throw error 
for invalid token
      Ôùï skipped 
should throw error 
if verification 
record not found
      Ôùï skipped 
should throw error 
if verification 
token is already used
      Ôùï skipped 
should throw error 
if verification 
token is expired
    login
      Ôùï skipped 
should successfully 
login with valid 
credentials
      Ôùï skipped 
should throw error 
if user not found
      Ôùï skipped 
should throw error 
if password is 
incorrect
      Ôùï skipped 
should throw error 
if user is not 
verified
      Ôùï skipped 
should throw error 
if user is not active
      Ôùï skipped 
should include 
student data in 
response
      Ôùï skipped 
should include 
faculty data in 
response
      Ôùï skipped 
should save refresh 
token with metadata
      Ôùï skipped 
should throw error 
when email or 
password is missing
      Ôùï skipped 
should map database 
connection errors to 
friendly message
      Ôùï skipped 
should throw 
friendly error when 
password comparison 
fails unexpectedly
    
refreshAccessToken
      Ôùï skipped 
should successfully 
refresh access token
      Ôùï skipped 
should throw error 
for invalid token
      Ôùï skipped 
should throw error 
if refresh token not 
found in database
      Ôùï skipped 
should throw error 
if refresh token is 
revoked
      Ôùï skipped 
should throw error 
if refresh token is 
expired
    logout
      Ôùï skipped 
should successfully 
logout and revoke 
refresh token
      Ôùï skipped 
should handle logout 
without token 
gracefully
      Ôùï skipped 
should handle logout 
with empty token 
gracefully
    forgotPassword
      Ôùï skipped 
should successfully 
send password reset 
email for existing 
user
      Ôùï skipped 
should return 
success message even 
if user does not 
exist (security)
      Ôùï skipped 
should invalidate 
old reset tokens
      Ôùï skipped 
should handle email 
sending failure 
gracefully
    resetPassword
      Ôùï skipped 
should successfully 
reset password with 
valid token
      Ôùï skipped 
should throw error 
for invalid token
      Ôùï skipped 
should throw error 
if reset record not 
found
      Ôùï skipped 
should throw error 
if reset token is 
already used
      Ôùï skipped 
should throw error 
if reset token is 
expired
      Ôùï skipped 
should invalidate 
all refresh tokens 
after password reset

  ÔùÅ Auth Service - 
Unit Tests ÔÇ║ 
register ÔÇ║ should 
successfully 
register a new 
student

    TypeError: 
user.toSafeObject is 
not a function

    [0m [90m 104 
|[39m     
[36mreturn[39m {
     [90m 105 
|[39m       
message[33m:[39m 
[32m'Kay─▒t ba┼şar─▒
l─▒.'[39m[33m,[39m
    [31m[1m>[22m[
39m[90m 106 |[39m  
     user[33m:[39m 
user[33m.[39mtoSafe
Object()[33m,[39m
     [90m     
|[39m               
   
[31m[1m^[22m[39m
     [90m 107 
|[39m     
}[33m;[39m
     [90m 108 
|[39m   } 
[36mcatch[39m 
(error) {
     [90m 109 
|[39m     
[36mawait[39m trans
action[33m.[39mroll
back()[33m;[39m[0m

      at 
Object.toSafeObject 
[as register] (src/se
rvices/authService.js
:106:18)
      at 
Object.<anonymous> (t
ests/unit/authService
.test.js:64:22)

  ÔùÅ Auth Service - 
Unit Tests ÔÇ║ 
register ÔÇ║ should 
successfully 
register a new 
faculty member

    TypeError: 
user.toSafeObject is 
not a function

    [0m [90m 104 
|[39m     
[36mreturn[39m {
     [90m 105 
|[39m       
message[33m:[39m 
[32m'Kay─▒t ba┼şar─▒
l─▒.'[39m[33m,[39m
    [31m[1m>[22m[
39m[90m 106 |[39m  
     user[33m:[39m 
user[33m.[39mtoSafe
Object()[33m,[39m
     [90m     
|[39m               
   
[31m[1m^[22m[39m
     [90m 107 
|[39m     
}[33m;[39m
     [90m 108 
|[39m   } 
[36mcatch[39m 
(error) {
     [90m 109 
|[39m     
[36mawait[39m trans
action[33m.[39mroll
back()[33m;[39m[0m

      at 
Object.toSafeObject 
[as register] (src/se
rvices/authService.js
:106:18)
      at 
Object.<anonymous> (t
ests/unit/authService
.test.js:104:22)

  ÔùÅ Auth Service - 
Unit Tests ÔÇ║ 
register ÔÇ║ should 
throw error if 
student number 
already exists

    expect(received).
rejects.toThrow(expec
ted)

    Expected 
substring: "Bu 
├Â─şrenci numaras─▒ 
zaten kay─▒tl─▒"
    Received 
message:   "Bu 
e-posta adresi zaten 
kay─▒tl─▒"

        [0m [90m 
36 |[39m   
[36mconst[39m 
existingUser 
[33m=[39m 
[36mawait[39m [33m
User[39m[33m.[39mf
indOne({ 
where[33m:[39m { 
email } })[33m;[39m
         [90m 37 
|[39m   
[36mif[39m 
(existingUser) {
        [31m[1m>[2
2m[39m[90m 38 
|[39m     
[36mthrow[39m 
[36mnew[39m [33mEr
ror[39m([32m'Bu 
e-posta adresi zaten 
kay─▒tl─▒'[39m)[33m
;[39m
         [90m    
|[39m           
[31m[1m^[22m[39m
         [90m 39 
|[39m   }
         [90m 40 
|[39m
         [90m 41 
|[39m   [90m// 
Check if student 
number already 
exists[39m[0m

      at 
Object.register (src/
services/authService.
js:38:11)
      at 
Object.<anonymous> (t
ests/unit/authService
.test.js:123:7)
      at 
Object.toThrow (node_
modules/expect/build/
index.js:218:22)
      at 
Object.toThrow (tests
/unit/authService.tes
t.js:123:64)

  ÔùÅ Auth Service - 
Unit Tests ÔÇ║ 
register ÔÇ║ should 
throw error if 
employee number 
already exists

    expect(received).
rejects.toThrow(expec
ted)

    Expected 
substring: "Bu 
personel numaras─▒ 
zaten kay─▒tl─▒"
    Received 
message:   "Bu 
e-posta adresi zaten 
kay─▒tl─▒"

        [0m [90m 
36 |[39m   
[36mconst[39m 
existingUser 
[33m=[39m 
[36mawait[39m [33m
User[39m[33m.[39mf
indOne({ 
where[33m:[39m { 
email } })[33m;[39m
         [90m 37 
|[39m   
[36mif[39m 
(existingUser) {
        [31m[1m>[2
2m[39m[90m 38 
|[39m     
[36mthrow[39m 
[36mnew[39m [33mEr
ror[39m([32m'Bu 
e-posta adresi zaten 
kay─▒tl─▒'[39m)[33m
;[39m
         [90m    
|[39m           
[31m[1m^[22m[39m
         [90m 39 
|[39m   }
         [90m 40 
|[39m
         [90m 41 
|[39m   [90m// 
Check if student 
number already 
exists[39m[0m

      at 
Object.register (src/
services/authService.
js:38:11)
      at 
Object.<anonymous> (t
ests/unit/authService
.test.js:136:7)
      at 
Object.toThrow (node_
modules/expect/build/
index.js:218:22)
      at 
Object.toThrow (tests
/unit/authService.tes
t.js:136:63)

----------------------------|---------|----------|---------|---------|---------------------------------------------------------------
File                        | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                             
----------------------------|---------|----------|---------|---------|---------------------------------------------------------------
All files                   |   14.52 |     13.6 |    4.16 |   14.87 |                                                               
 controllers                |       0 |        0 |       0 |       0 |                                                               
  announcementController.js |       0 |        0 |       0 |       0 | 1-178                                                         
 services                   |   18.37 |    17.96 |    5.88 |   18.69 |                                                               
  authService.js            |    28.1 |    29.11 |    12.5 |   28.28 | 45,53,122-148,160-263,278-302,310-317,338-378,387-401,413-465 
  userService.js            |       0 |        0 |       0 |       0 | 1-275                                                         
 utils                      |       0 |        0 |       0 |       0 |                                                               
  logger.js                 |       0 |        0 |       0 |       0 | 1-46                                                          
----------------------------|---------|----------|---------|---------|---------------------------------------------------------------
Test Suites: 1 
failed, 1 total
Tests:       4 
failed, 34 skipped, 
3 passed, 41 total
Snapshots:   0 total
Time:        2.045 s
Ran all test suites 
matching /authService
.test.js/i with 
tests matching 
"register".
