# ==========================================
# Google Cloud Build Configuration
# ==========================================
# Cloud Run'a otomatik deploy i√ßin

steps:
  # Build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/obs-api:$COMMIT_SHA'
      - '-t'
      - 'gcr.io/$PROJECT_ID/obs-api:latest'
      - '.'

  # Push the Docker image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/obs-api:$COMMIT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/obs-api:latest'

  # Deploy to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'obs-api'
      - '--image'
      - 'gcr.io/$PROJECT_ID/obs-api:$COMMIT_SHA'
      - '--region'
      - 'europe-west1'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--port'
      - '5000'
      - '--memory'
      - '512Mi'
      - '--cpu'
      - '1'
      - '--min-instances'
      - '0'
      - '--max-instances'
      - '10'
      - '--set-env-vars'
      - 'NODE_ENV=production,FRONTEND_URL=https://obs-frontend-214391529742.europe-west1.run.app'
      - '--set-secrets'
      - 'DB_HOST=DB_HOST:latest,DB_USER=DB_USER:latest,DB_PASSWORD=DB_PASSWORD:latest,DB_NAME=DB_NAME:latest,JWT_SECRET=JWT_SECRET:latest'

  # Seed veritabanƒ± (otomatik - her deploy'da √ßalƒ±≈üƒ±r)
  # findOrCreate kullandƒ±ƒüƒ± i√ßin veriler tekrar olu≈üturulmaz, g√ºvenli
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - '-c'
      - |
        echo "üå± Veritabanƒ± seed i≈ülemi ba≈ülatƒ±lƒ±yor..."
        
        # Cloud SQL instance name'ini DB_HOST secret'ƒ±ndan al
        DB_HOST_VALUE=$(gcloud secrets versions access latest --secret=DB_HOST --project=$PROJECT_ID 2>/dev/null || echo "")
        
        # Eƒüer DB_HOST /cloudsql/ ile ba≈ülƒ±yorsa, Cloud SQL instance name'ini √ßƒ±kar
        if [[ "$DB_HOST_VALUE" == /cloudsql/* ]]; then
          SQL_INSTANCE=$(echo "$DB_HOST_VALUE" | sed 's|/cloudsql/||')
          echo "üìä Cloud SQL Instance: $SQL_INSTANCE"
          CLOUDSQL_ARG="--add-cloudsql-instances $SQL_INSTANCE"
        else
          echo "üìä Normal DB Host kullanƒ±lƒ±yor"
          CLOUDSQL_ARG=""
        fi
        
        # Seed job'unu olu≈ütur veya g√ºncelle
        if gcloud run jobs describe seed-database --region=europe-west1 --project=$PROJECT_ID >/dev/null 2>&1; then
          echo "üîÑ Mevcut seed job g√ºncelleniyor..."
          gcloud run jobs update seed-database \
            --image gcr.io/$PROJECT_ID/obs-api:$COMMIT_SHA \
            --region europe-west1 \
            --project=$PROJECT_ID \
            $CLOUDSQL_ARG \
            --set-env-vars "NODE_ENV=production" \
            --set-secrets "DB_HOST=DB_HOST:latest,DB_USER=DB_USER:latest,DB_PASSWORD=DB_PASSWORD:latest,DB_NAME=DB_NAME:latest,JWT_SECRET=JWT_SECRET:latest" \
            --command "node" \
            --args "src/seeders/seedPart2Data.js" \
            --max-retries 1 \
            --task-timeout 10m \
            --memory 512Mi \
            --cpu 1 \
            --quiet
        else
          echo "üÜï Yeni seed job olu≈üturuluyor..."
          gcloud run jobs create seed-database \
            --image gcr.io/$PROJECT_ID/obs-api:$COMMIT_SHA \
            --region europe-west1 \
            --project=$PROJECT_ID \
            $CLOUDSQL_ARG \
            --set-env-vars "NODE_ENV=production" \
            --set-secrets "DB_HOST=DB_HOST:latest,DB_USER=DB_USER:latest,DB_PASSWORD=DB_PASSWORD:latest,DB_NAME=DB_NAME:latest,JWT_SECRET=JWT_SECRET:latest" \
            --command "node" \
            --args "src/seeders/seedPart2Data.js" \
            --max-retries 1 \
            --task-timeout 10m \
            --memory 512Mi \
            --cpu 1 \
            --quiet
        fi
        
        # Job'u √ßalƒ±≈ütƒ±r
        echo "‚ñ∂Ô∏è Seed job √ßalƒ±≈ütƒ±rƒ±lƒ±yor..."
        gcloud run jobs execute seed-database \
          --region europe-west1 \
          --project=$PROJECT_ID \
          --wait
        
        echo "‚úÖ Seed i≈ülemi tamamlandƒ±!"

# Store images in Container Registry
images:
  - 'gcr.io/$PROJECT_ID/obs-api:$COMMIT_SHA'
  - 'gcr.io/$PROJECT_ID/obs-api:latest'

# Build timeout
timeout: '1200s'

# Build options
options:
  logging: CLOUD_LOGGING_ONLY

